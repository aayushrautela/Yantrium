name: Build Windows

# Manual trigger only - doesn't run on every commit
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'  # Use latest stable Flutter

    - name: Install dependencies
      run: flutter pub get

    - name: Create .env file
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" > .env
        echo "TMDB_BASE_URL=https://api.themoviedb.org/3" >> .env
        echo "TMDB_IMAGE_BASE_URL=https://image.tmdb.org/t/p" >> .env
        echo "TRAKT_CLIENT_ID=${{ secrets.TRAKT_CLIENT_ID }}" >> .env
        echo "TRAKT_CLIENT_SECRET=${{ secrets.TRAKT_CLIENT_SECRET }}" >> .env
        echo "TRAKT_REDIRECT_URI=yantrium://auth/trakt" >> .env
      shell: bash

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Create Windows platform support
      run: flutter create --platforms=windows .

    - name: Build Windows ${{ inputs.build_type }}
      run: flutter build windows --${{ inputs.build_type }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: yatrium-windows-${{ inputs.build_type }}
        path: build/windows/x64/runner/${{ inputs.build_type == 'release' && 'Release' || 'Debug' }}/
        retention-days: 30
