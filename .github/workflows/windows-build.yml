name: Build Windows

# Manual trigger only - doesn't run on every commit
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'  # Use latest stable Flutter

    - name: Install dependencies
      run: flutter pub get

    - name: Create .env file
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" > .env
        echo "TMDB_BASE_URL=https://api.themoviedb.org/3" >> .env
        echo "TMDB_IMAGE_BASE_URL=https://image.tmdb.org/t/p" >> .env
        echo "TRAKT_CLIENT_ID=${{ secrets.TRAKT_CLIENT_ID }}" >> .env
        echo "TRAKT_CLIENT_SECRET=${{ secrets.TRAKT_CLIENT_SECRET }}" >> .env
        echo "TRAKT_REDIRECT_URI=yantrium://auth/trakt" >> .env
      shell: bash

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Create Windows platform support
      run: flutter create --platforms=windows .

    - name: Verify API keys are available
      run: |
        echo "Verifying API keys for embedding..."
        
        TMDB_KEY="${{ secrets.TMDB_API_KEY }}"
        TRAKT_ID="${{ secrets.TRAKT_CLIENT_ID }}"
        TRAKT_SECRET="${{ secrets.TRAKT_CLIENT_SECRET }}"
        
        if [ -z "$TMDB_KEY" ]; then
          echo "ERROR: TMDB_API_KEY secret is not set!"
          exit 1
        else
          TMDB_LEN=${#TMDB_KEY}
          echo "TMDB_API_KEY is set (length: $TMDB_LEN characters)"
        fi
        
        if [ -z "$TRAKT_ID" ]; then
          echo "ERROR: TRAKT_CLIENT_ID secret is not set!"
          exit 1
        else
          TRAKT_ID_LEN=${#TRAKT_ID}
          echo "TRAKT_CLIENT_ID is set (length: $TRAKT_ID_LEN characters)"
        fi
        
        if [ -z "$TRAKT_SECRET" ]; then
          echo "ERROR: TRAKT_CLIENT_SECRET secret is not set!"
          exit 1
        else
          TRAKT_SECRET_LEN=${#TRAKT_SECRET}
          echo "TRAKT_CLIENT_SECRET is set (length: $TRAKT_SECRET_LEN characters)"
        fi
        
        echo "All API keys verified! Keys will be embedded via --dart-define flags."
        echo "Building with embedded API keys..."
      shell: bash

    - name: Build Windows ${{ inputs.build_type }}
      run: |
        echo "   Starting build with embedded API keys..."
        echo "   Build type: ${{ inputs.build_type }}"
        echo "   Using --dart-define flags for API key injection"
        flutter build windows --${{ inputs.build_type }} \
          --dart-define=TMDB_API_KEY=${{ secrets.TMDB_API_KEY }} \
          --dart-define=TRAKT_CLIENT_ID=${{ secrets.TRAKT_CLIENT_ID }} \
          --dart-define=TRAKT_CLIENT_SECRET=${{ secrets.TRAKT_CLIENT_SECRET }}
        echo "Build completed with embedded API keys"
      shell: bash

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: yatrium-windows-${{ inputs.build_type }}
        path: build/windows/x64/runner/${{ inputs.build_type == 'release' && 'Release' || 'Debug' }}/
        retention-days: 30
